name: 'Secrets Scanner Test Workflow'
on: [push, pull_request]
jobs:
  test_secrets_scanner:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3  # Correctly refer to an official GitHub Action to checkout the code

      - name: Set up Python
        uses: actions/setup-python@v2  # Correct reference to set up Python environment
        with:
          python-version: '3.x'

      - name: Install TruffleHog
        run: |
          python --version  # Check Python version
          pip install trufflehog  # Install TruffleHog using pip

      - name: Install Gitleaks
        run: |
          echo "Installing Gitleaks..."
          curl -sSfL https://github.com/zricethezav/gitleaks/releases/download/v8.5.0/gitleaks_8.5.0_linux_x64.tar.gz | tar -xz -C /usr/local/bin
          chmod +x /usr/local/bin/gitleaks
          gitleaks version  # Verify Gitleaks installation

      - name: Debug Directory
        run: |
          echo "Current directory content:"
          ls -la

      - name: Run TruffleHog Secrets Scanner
        id: trufflehog_scan
        run: |
          echo "Running TruffleHog..."
          trufflehog filesystem . --json > trufflehog-results.txt || echo "No secrets detected by TruffleHog." > trufflehog-results.txt
          if [ ! -s trufflehog-results.txt ]; then
            echo "No secrets detected by TruffleHog." > trufflehog-results.txt
          fi

      - name: Run Gitleaks Secrets Scanner
        id: gitleaks_scan
        run: |
          echo "Running Gitleaks..."
          gitleaks detect -v --source . --report-format json --report-path gitleaks-results.json || echo '[]' > gitleaks-results.json
          if [ ! -s gitleaks-results.json ]; then
            echo '[]' > gitleaks-results.json  # Create empty JSON if no secrets detected
          fi

      - name: Upload TruffleHog Results
        if: always()
        uses: actions/upload-artifact@v3  # Correctly refer to upload-artifact action
        with:
          name: trufflehog-results
          path: trufflehog-results.txt

      - name: Upload Gitleaks Results
        if: always()
        uses: actions/upload-artifact@v3  # Correct reference for uploading artifacts
        with:
          name: gitleaks-results
          path: gitleaks-results.json

      - name: Send Email Notification
        if: always()  # Always run, regardless of success or failure
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com # Replace with your SMTP server address
          server_port: 587                  # SMTP port, typically 587 for TLS or 465 for SSL
          username: ${{ secrets.EMAIL_USERNAME }}  # Your SMTP username, typically your email address
          password: ${{ secrets.EMAIL_PASSWORD }}  # Your SMTP password, stored securely in GitHub secrets
          subject: "Secrets Scanner Results Notification"
          to: "benjaminvermeulen22@gmail.com"  # Replace with your email address
          from: "benjaminvermeulen22@gmail.com"  # Replace with your sender email address
          content_type: text/plain
          body: |
            Hello,

            The secrets scanner has completed its run.

            $(if grep -q -v 'No secrets detected by TruffleHog' trufflehog-results.txt || ([ -s gitleaks-results.json ] && [ "$(cat gitleaks-results.json)" != "[]" ]); then
              echo "ðŸš¨ Secrets were detected in the repository! Please review the scan results."
            else
              echo "âœ… No secrets detected by either TruffleHog or Gitleaks. All clear!"
            fi)

            You can review the full results in the GitHub Actions Artifacts section.

            Best regards,
            Secrets Scanner Bot
